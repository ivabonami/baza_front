<template>
  <div class="send-review box-shadow"

       v-on:keydown.enter="() => {

       }">
    <div class="send-header">
      <div class="text">
        <h3 class="your-rating">
          Ваша оценка
        </h3>

      </div>
      <div class="set-rating"
           ref="el">
        <div class="star" :class="{active : this.review.rating >= 1}">
          <svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 19 18" fill="none" @click="setReviewRating(1)">
            <path d="M8.63477 0.823678C8.86331 0.356738 8.97757 0.123269 9.1327 0.0486752C9.26767 -0.0162251 9.42447 -0.0162251 9.55944 0.0486752C9.71456 0.123269 9.82883 0.356738 10.0574 0.823677L12.2255 5.25364C12.293 5.3915 12.3267 5.46042 12.3761 5.51394C12.4197 5.56132 12.4721 5.59971 12.5302 5.62698C12.5959 5.65778 12.6713 5.6689 12.8221 5.69113L17.672 6.40607C18.1827 6.48135 18.4381 6.519 18.5563 6.6448C18.6591 6.75425 18.7074 6.90466 18.6879 7.05414C18.6654 7.22594 18.4805 7.40754 18.1108 7.77074L14.6027 11.2168C14.4933 11.3242 14.4386 11.3779 14.4033 11.4418C14.3721 11.4984 14.3521 11.5606 14.3443 11.6249C14.3356 11.6975 14.3485 11.7734 14.3743 11.9251L15.2021 16.7925C15.2894 17.3059 15.333 17.5625 15.251 17.7149C15.1796 17.8474 15.0527 17.9403 14.9057 17.9678C14.7367 17.9994 14.5081 17.8782 14.051 17.6358L9.71528 15.3362C9.58019 15.2645 9.51264 15.2287 9.44148 15.2146C9.37847 15.2022 9.31366 15.2022 9.25066 15.2146C9.17949 15.2287 9.11195 15.2645 8.97686 15.3362L4.64111 17.6358C4.184 17.8782 3.95545 17.9994 3.78645 17.9678C3.63942 17.9403 3.51254 17.8474 3.44116 17.7149C3.35913 17.5625 3.40278 17.3058 3.49008 16.7925L4.31783 11.9251C4.34364 11.7734 4.35654 11.6975 4.34781 11.6249C4.34008 11.5606 4.32004 11.4984 4.2888 11.4418C4.25352 11.3779 4.19884 11.3242 4.08948 11.2168L0.581381 7.77074C0.211639 7.40754 0.0267676 7.22594 0.0042711 7.05414C-0.0153021 6.90466 0.0330528 6.75425 0.135873 6.6448C0.254049 6.519 0.509407 6.48135 1.02012 6.40607L5.87002 5.69113C6.02084 5.6689 6.09626 5.65778 6.16193 5.62698C6.22008 5.59971 6.27243 5.56132 6.31608 5.51394C6.36539 5.46042 6.39912 5.3915 6.46659 5.25364L8.63477 0.823678Z" fill="#D8D8D8"/>
          </svg>
        </div>
        <div class="star" :class="{active : this.review.rating >= 2}">
          <svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 19 18" fill="none" @click="setReviewRating(2)">
            <path d="M8.63477 0.823678C8.86331 0.356738 8.97757 0.123269 9.1327 0.0486752C9.26767 -0.0162251 9.42447 -0.0162251 9.55944 0.0486752C9.71456 0.123269 9.82883 0.356738 10.0574 0.823677L12.2255 5.25364C12.293 5.3915 12.3267 5.46042 12.3761 5.51394C12.4197 5.56132 12.4721 5.59971 12.5302 5.62698C12.5959 5.65778 12.6713 5.6689 12.8221 5.69113L17.672 6.40607C18.1827 6.48135 18.4381 6.519 18.5563 6.6448C18.6591 6.75425 18.7074 6.90466 18.6879 7.05414C18.6654 7.22594 18.4805 7.40754 18.1108 7.77074L14.6027 11.2168C14.4933 11.3242 14.4386 11.3779 14.4033 11.4418C14.3721 11.4984 14.3521 11.5606 14.3443 11.6249C14.3356 11.6975 14.3485 11.7734 14.3743 11.9251L15.2021 16.7925C15.2894 17.3059 15.333 17.5625 15.251 17.7149C15.1796 17.8474 15.0527 17.9403 14.9057 17.9678C14.7367 17.9994 14.5081 17.8782 14.051 17.6358L9.71528 15.3362C9.58019 15.2645 9.51264 15.2287 9.44148 15.2146C9.37847 15.2022 9.31366 15.2022 9.25066 15.2146C9.17949 15.2287 9.11195 15.2645 8.97686 15.3362L4.64111 17.6358C4.184 17.8782 3.95545 17.9994 3.78645 17.9678C3.63942 17.9403 3.51254 17.8474 3.44116 17.7149C3.35913 17.5625 3.40278 17.3058 3.49008 16.7925L4.31783 11.9251C4.34364 11.7734 4.35654 11.6975 4.34781 11.6249C4.34008 11.5606 4.32004 11.4984 4.2888 11.4418C4.25352 11.3779 4.19884 11.3242 4.08948 11.2168L0.581381 7.77074C0.211639 7.40754 0.0267676 7.22594 0.0042711 7.05414C-0.0153021 6.90466 0.0330528 6.75425 0.135873 6.6448C0.254049 6.519 0.509407 6.48135 1.02012 6.40607L5.87002 5.69113C6.02084 5.6689 6.09626 5.65778 6.16193 5.62698C6.22008 5.59971 6.27243 5.56132 6.31608 5.51394C6.36539 5.46042 6.39912 5.3915 6.46659 5.25364L8.63477 0.823678Z" fill="#D8D8D8"/>
          </svg>
        </div>
        <div class="star" :class="{active : this.review.rating >= 3}">
          <svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 19 18" fill="none" @click="setReviewRating(3)">
            <path d="M8.63477 0.823678C8.86331 0.356738 8.97757 0.123269 9.1327 0.0486752C9.26767 -0.0162251 9.42447 -0.0162251 9.55944 0.0486752C9.71456 0.123269 9.82883 0.356738 10.0574 0.823677L12.2255 5.25364C12.293 5.3915 12.3267 5.46042 12.3761 5.51394C12.4197 5.56132 12.4721 5.59971 12.5302 5.62698C12.5959 5.65778 12.6713 5.6689 12.8221 5.69113L17.672 6.40607C18.1827 6.48135 18.4381 6.519 18.5563 6.6448C18.6591 6.75425 18.7074 6.90466 18.6879 7.05414C18.6654 7.22594 18.4805 7.40754 18.1108 7.77074L14.6027 11.2168C14.4933 11.3242 14.4386 11.3779 14.4033 11.4418C14.3721 11.4984 14.3521 11.5606 14.3443 11.6249C14.3356 11.6975 14.3485 11.7734 14.3743 11.9251L15.2021 16.7925C15.2894 17.3059 15.333 17.5625 15.251 17.7149C15.1796 17.8474 15.0527 17.9403 14.9057 17.9678C14.7367 17.9994 14.5081 17.8782 14.051 17.6358L9.71528 15.3362C9.58019 15.2645 9.51264 15.2287 9.44148 15.2146C9.37847 15.2022 9.31366 15.2022 9.25066 15.2146C9.17949 15.2287 9.11195 15.2645 8.97686 15.3362L4.64111 17.6358C4.184 17.8782 3.95545 17.9994 3.78645 17.9678C3.63942 17.9403 3.51254 17.8474 3.44116 17.7149C3.35913 17.5625 3.40278 17.3058 3.49008 16.7925L4.31783 11.9251C4.34364 11.7734 4.35654 11.6975 4.34781 11.6249C4.34008 11.5606 4.32004 11.4984 4.2888 11.4418C4.25352 11.3779 4.19884 11.3242 4.08948 11.2168L0.581381 7.77074C0.211639 7.40754 0.0267676 7.22594 0.0042711 7.05414C-0.0153021 6.90466 0.0330528 6.75425 0.135873 6.6448C0.254049 6.519 0.509407 6.48135 1.02012 6.40607L5.87002 5.69113C6.02084 5.6689 6.09626 5.65778 6.16193 5.62698C6.22008 5.59971 6.27243 5.56132 6.31608 5.51394C6.36539 5.46042 6.39912 5.3915 6.46659 5.25364L8.63477 0.823678Z" fill="#D8D8D8"/>
          </svg>
        </div>
        <div class="star" :class="{active : this.review.rating >= 4}">
          <svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 19 18" fill="none" @click="setReviewRating(4)">
            <path d="M8.63477 0.823678C8.86331 0.356738 8.97757 0.123269 9.1327 0.0486752C9.26767 -0.0162251 9.42447 -0.0162251 9.55944 0.0486752C9.71456 0.123269 9.82883 0.356738 10.0574 0.823677L12.2255 5.25364C12.293 5.3915 12.3267 5.46042 12.3761 5.51394C12.4197 5.56132 12.4721 5.59971 12.5302 5.62698C12.5959 5.65778 12.6713 5.6689 12.8221 5.69113L17.672 6.40607C18.1827 6.48135 18.4381 6.519 18.5563 6.6448C18.6591 6.75425 18.7074 6.90466 18.6879 7.05414C18.6654 7.22594 18.4805 7.40754 18.1108 7.77074L14.6027 11.2168C14.4933 11.3242 14.4386 11.3779 14.4033 11.4418C14.3721 11.4984 14.3521 11.5606 14.3443 11.6249C14.3356 11.6975 14.3485 11.7734 14.3743 11.9251L15.2021 16.7925C15.2894 17.3059 15.333 17.5625 15.251 17.7149C15.1796 17.8474 15.0527 17.9403 14.9057 17.9678C14.7367 17.9994 14.5081 17.8782 14.051 17.6358L9.71528 15.3362C9.58019 15.2645 9.51264 15.2287 9.44148 15.2146C9.37847 15.2022 9.31366 15.2022 9.25066 15.2146C9.17949 15.2287 9.11195 15.2645 8.97686 15.3362L4.64111 17.6358C4.184 17.8782 3.95545 17.9994 3.78645 17.9678C3.63942 17.9403 3.51254 17.8474 3.44116 17.7149C3.35913 17.5625 3.40278 17.3058 3.49008 16.7925L4.31783 11.9251C4.34364 11.7734 4.35654 11.6975 4.34781 11.6249C4.34008 11.5606 4.32004 11.4984 4.2888 11.4418C4.25352 11.3779 4.19884 11.3242 4.08948 11.2168L0.581381 7.77074C0.211639 7.40754 0.0267676 7.22594 0.0042711 7.05414C-0.0153021 6.90466 0.0330528 6.75425 0.135873 6.6448C0.254049 6.519 0.509407 6.48135 1.02012 6.40607L5.87002 5.69113C6.02084 5.6689 6.09626 5.65778 6.16193 5.62698C6.22008 5.59971 6.27243 5.56132 6.31608 5.51394C6.36539 5.46042 6.39912 5.3915 6.46659 5.25364L8.63477 0.823678Z" fill="#D8D8D8"/>
          </svg>
        </div>
        <div class="star" :class="{active : this.review.rating >= 5}">
          <svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 19 18" fill="none" @click="setReviewRating(5)">
            <path d="M8.63477 0.823678C8.86331 0.356738 8.97757 0.123269 9.1327 0.0486752C9.26767 -0.0162251 9.42447 -0.0162251 9.55944 0.0486752C9.71456 0.123269 9.82883 0.356738 10.0574 0.823677L12.2255 5.25364C12.293 5.3915 12.3267 5.46042 12.3761 5.51394C12.4197 5.56132 12.4721 5.59971 12.5302 5.62698C12.5959 5.65778 12.6713 5.6689 12.8221 5.69113L17.672 6.40607C18.1827 6.48135 18.4381 6.519 18.5563 6.6448C18.6591 6.75425 18.7074 6.90466 18.6879 7.05414C18.6654 7.22594 18.4805 7.40754 18.1108 7.77074L14.6027 11.2168C14.4933 11.3242 14.4386 11.3779 14.4033 11.4418C14.3721 11.4984 14.3521 11.5606 14.3443 11.6249C14.3356 11.6975 14.3485 11.7734 14.3743 11.9251L15.2021 16.7925C15.2894 17.3059 15.333 17.5625 15.251 17.7149C15.1796 17.8474 15.0527 17.9403 14.9057 17.9678C14.7367 17.9994 14.5081 17.8782 14.051 17.6358L9.71528 15.3362C9.58019 15.2645 9.51264 15.2287 9.44148 15.2146C9.37847 15.2022 9.31366 15.2022 9.25066 15.2146C9.17949 15.2287 9.11195 15.2645 8.97686 15.3362L4.64111 17.6358C4.184 17.8782 3.95545 17.9994 3.78645 17.9678C3.63942 17.9403 3.51254 17.8474 3.44116 17.7149C3.35913 17.5625 3.40278 17.3058 3.49008 16.7925L4.31783 11.9251C4.34364 11.7734 4.35654 11.6975 4.34781 11.6249C4.34008 11.5606 4.32004 11.4984 4.2888 11.4418C4.25352 11.3779 4.19884 11.3242 4.08948 11.2168L0.581381 7.77074C0.211639 7.40754 0.0267676 7.22594 0.0042711 7.05414C-0.0153021 6.90466 0.0330528 6.75425 0.135873 6.6448C0.254049 6.519 0.509407 6.48135 1.02012 6.40607L5.87002 5.69113C6.02084 5.6689 6.09626 5.65778 6.16193 5.62698C6.22008 5.59971 6.27243 5.56132 6.31608 5.51394C6.36539 5.46042 6.39912 5.3915 6.46659 5.25364L8.63477 0.823678Z" fill="#D8D8D8"/>
          </svg>
        </div>
      </div>
    </div>

    <textarea
        v-model="review.text"
        maxlength="2000"
        placeholder="Текст отзыва, не обязательно"></textarea>
    <div class="reviewTextError" v-if="errors !== ''">
      {{ review.error }}
    </div>
    <div class="buttons">
      <button class="baza-button primary" v-on:click="(event) => {

        if (editMode === true) {
          useFetch(`reviews/${review.id}`, 'PUT', {
            rating: review.rating,
            comment: review.text,
            projectId: review.projectId,



          }).then(result => {
            this.$emit('dataAdded', true)
            modalSetting.show = true
            modalSetting.headline = `Отзыв обновлен`
            modalSetting.description = `Вы успешно обновили отзыв!`
            modalSetting.type = 'ok'
            modalSetting.modalSize = 'small'

          })


        } else {
          if (review.rating <= 0) {
          review.error = 'Выставите рейтинг'
        } else {
          delete review.error
          useFetch(`reviews`, 'POST', {
            rating: review.rating,
            comment: review.text,
            projectId: review.projectId

          })
          .then(result => {

            if (result.success === true) {
              modalSetting.show = true
              modalSetting.headline = `Вы опубликовали отзыв!`
              modalSetting.description = `Вы успешно опубликовали отзыв!`
              modalSetting.type = 'ok'
              modalSetting.modalSize = 'small'

              projectReviews[0].push({
                rating: review.rating,
                comment: review.text,
                projectId: review.projectId,
                isReviewed: true,
                createdAt: new Date(),
                userData: {
                  username: userInfo.username
                }
              })
              console.log(projectReviews[0])
            }




          })
          .catch(err => {
            console.log(err)
          })
        }
        }

      }"
      >

        <span v-if="this.editMode === true">Отправить</span>
        <span  v-else>Оставить отзыв</span>
      </button>
      <button class="baza-button "
              v-on:click="clearTextarea()">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="13" viewBox="0 0 14 13" fill="none">
          <path d="M1 0.5L13 12.5M1 12.5L13 0.5" stroke="#2B2B2B"/>
        </svg>
        Очистить
      </button>
    </div>
  </div>
</template>

<script>
import {useFetch} from "../../assets/js/controllers/requestsControl.js";
import {watch} from "vue";
import {modalSetting} from "../../assets/js/modal.js";
import {projectReviews} from "../../assets/js/reviews.js";
import {userInfo} from "../../Store/userInfo.js";

export default {
  name: "addTestimonial.vue",
  data() {
    return {
      review: {
        text: '',
        rating: 0,
        id: 0,
        error: '',
        projectId: window.location.pathname.replace('/project/', '')
      },
      editMode: false,
      errors: {},
      useFetch, modalSetting, projectReviews, userInfo
    }
  },
  setup() {
    watch(modalSetting, (value, oldValue) => {
    }, { immediate: true })

    watch(projectReviews, (value, oldValue) => {
    }, { immediate: true })
  },
  components: {},
  methods: {
    setReviewRating(count) {
      this.review.rating = count
    }
  },
  mounted() {
    if (modalSetting.testimonialEditMode === true) {
      this.review.text = modalSetting.testimonial.text
      this.review.rating = modalSetting.testimonial.rating
      this.review.id = modalSetting.testimonial.id
      this.editMode = true
    }
  },
}

// TODO добавление отзыва от юзера не должно добавлять отзыв в массив и отображаться, раз оно падает в ревью

</script>

<style scoped lang="scss">
h3 {
  font-weight: 400;
}
.send-header {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;

  .set-rating {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;

    .star {
      cursor: pointer;
      opacity: .3;

      &.active {
        opacity: 1;
      }



      svg {

        path {
          transition: .3s ease;
          fill: #000;
        }
      }

      &:hover {
        svg {
          opacity: .8;
        }
      }


    }
  }
  p {
    width: 100%;
  }
}

</style>